<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>写真帳作成ページ</title>
  <style>
    #header {
      display: none;
    }
    #headerText {
      display: block;
      height: 1.5em;
      width: 25%;
    }
    #fileSelectorLabel, #headerTextLabel {
      display: block;
      margin-top: 1em;
    }
    .imageDiv {
      display: flex;
      margin-top: 10mm;
      border: solid 1px gray;
      background-color: lightcyan;
      cursor: grab;
    }
    .thumb {
      border: solid 1px gray;
      width: 360px;
      height: auto;
    }
    .imageCaption {
      vertical-align: top;
      margin-left: 1em;
      margin-right: 10em;
      background-color: whitesmoke;
    }
    @media print {  
      body {
        width: 210mm;
      }
      #header {
        display: block;
        font-size: x-large;
        text-align: center;
        position: fixed;
        top: 10mm;
        width: 100%;
        margin-bottom: 5mm;
      }
      #fileSelector, #fileSelectorLabel,
      #headerText, #headerTextLabel,
      .informationP, .landmarkP
      {
        display: none;
      }
      .imageDiv {
        padding-top: 20mm;
        padding-left: 25mm;
        padding-right: 20mm;
        break-inside: avoid;
        margin: 0;
        border: none;
        background-color: white;
      }
      .thumb {
        width: 480px;
        height: auto;
      }
      .imageCaption {
        padding-right: 10mm;
        background-color: white;
        margin-right: 0;
      }
      @page {
        size: A4;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="header" id="header"></div>
    <div id="informationDiv">
      <div>
        <label class="fileSelectorLabel" id="fileSelectorLabel" for="folderSelector">表示する画像を選択してください</label>
        <input type="file" id="fileSelector" accept="image/*" multiple />
      </div>
      <div>
        <label class="headerText" id="headerTextLabel" for="headerText">ヘッダーとして表示する文言を入力してください</label>
        <input type="text" size="40" id="headerText">
      </div>
      <p class="informationP">印刷されるのは画像とファイル名だけです</p>
      <p class="informationP">画像は水色で塗りつぶした箇所をドラッグして並び替えができます</p>
      <p class="informationP">ファイル名をダブルクリックすると変更できます</p>
      <span class="informationP">対象ファイル数: </span>
      <span id="imageCount" class="informationP">0</span>
      <span class="informationP">, </span>
      <span class="informationP">読み込み成功: </span>
      <span id="readSuccessCount" class="informationP">0</span>
      <span class="informationP">, </span>
      <span class="informationP">読み込み失敗: </span>
      <span id="readErrorCount" class="informationP">0</span>
      <span class="informationP">, </span>
      <span class="informationP">画像以外のファイル: </span>
      <span id="readNotImageCount" class="informationP">0</span>
    </div>
    <p id="progressP"></p>
    <div id="imageList"></div>  
  </div>
</body>
<script>
  document.getElementById("fileSelector").addEventListener("change", ev => {
    let readErrorCount = 0;
    let readSuccessCount = 0;
    let readNotImageCount = 0;
    let readFileCount = 0;
    let imageFiles = [];
    const imageCountSpan = document.getElementById('imageCount');
    const readSuccessCountSpan = document.getElementById('readSuccessCount');
    const readErrorCountSpan = document.getElementById('readErrorCount');
    const readNotImageCountSpan = document.getElementById('readNotImageCount');
    // 読み込むファイルの拡張子を指定
    const fileTypes = ['jpg', 'jpeg', 'png', 'bmp', 'gif'];

    // 再読み込みのために読み込んだ画像を消去してカウンターを初期化する
    let divImageList = document.getElementById('imageList');
    while (divImageList.firstChild) {
      divImageList.removeChild(divImageList.firstChild);
    }
    imageCountSpan.innerText = 0;
    readSuccessCountSpan.innerText = 0;
    readErrorCountSpan.innerText = 0;
    readNotImageCountSpan.innerText = 0;

    imageCountSpan.innerText = ev.target.files.length;
    document.getElementById('progressP').innerText = '読み込み中';

    Array.from(ev.target.files).forEach((file) => {
      // まず拡張子で画像ファイルか判断し、読み込み後にマジックナンバーを確認して
      // img.src に読み込ませるか判断する。
      let extension = file.name.split('.').pop().toLowerCase();
      let isImageExtension = fileTypes.indexOf(extension) > -1;
      if (!isImageExtension) {
        ++readNotImageCount;
        console.log('not image file: ' + readNotImageCount);
        readNotImageCountSpan.innerText = readNotImageCount;
        return;
      }

      let fileReader = new FileReader();
      fileReader.readAsArrayBuffer(file); 
      fileReader.addEventListener('loadstart', (() => {
        console.log('loading: ' + file.name);
      })(file));
      fileReader.addEventListener('error', () => {
        ++readErrorCount;
        console.log('read error: ' + readErrorCount)
        readFileCount = readSuccessCount + readErrorCount;
        readErrorCountSpan.innerText = readErrorCount;
        if (readFileCount == ev.target.files.length) {
            imageListDom(imageFiles);
        }
      });
      fileReader.addEventListener('load', (() => {
        return (e) => {
          // console.warn(file.name + ' is ' + getImageFormat(e.target.result));
          if (!getImageFormat(e.target.result)) {
            ++readNotImageCount;
            console.log('not image file: ' + readNotImageCount);
            readNotImageCountSpan.innerText = readNotImageCount;
          } else {
            let imageFile = {name: '', image: ''};
            ++readSuccessCount;
            readSuccessCountSpan.innerText = readSuccessCount;
            console.log('read success: ' + readSuccessCount)
            imageFile.name = file.name;
            imageFile.image = e.target.result;
            imageFiles.push(imageFile);
            // console.table(imageFiles);
          }
          readFileCount = readSuccessCount + readErrorCount + readNotImageCount;
          console.info('read file count: ' + readFileCount);
          if (readFileCount == ev.target.files.length) {
            imageListDom(imageFiles);
          }
        }
      })(file));
    })
  });

  // ドラッグで順番を入れ替える処理
  const elm = document.getElementById('imageList');
  elm.addEventListener('dragstart', function(event) {
    if (event.target.classList.contains('imageDiv')) {
      // console.info('dragstart start.');
      event.dataTransfer.setData('text/plain', event.target.id);
    }
  });
  elm.addEventListener('dragover', function(event) {
    let underImage = document.getElementById(event.target.id);
    if (event.target.classList.contains('imageDiv')) {
      event.preventDefault();
      let rect = underImage.getBoundingClientRect();
      if ((event.clientY - rect.top) < (underImage.clientHeight /2)) {
        // console.info(rect.top);
        //マウスカーソルの位置が要素の半分より上
        underImage.style.borderTop = '20px solid blue';
  			underImage.style.borderBottom = '';
      } else {
        //マウスカーソルの位置が要素の半分より下
        underImage.style.borderTop = '';
  			underImage.style.borderBottom = '20px solid blue';
      }
    }
  })
  elm.addEventListener('dragleave', function(event) {
    let underImage = document.getElementById(event.target.id);
    if (event.target.classList.contains('imageDiv')) {
      underImage.style.borderTop = '';
			underImage.style.borderBottom = '';
    }
  })
  elm.addEventListener('drop', function(event) {
    let underImage = document.getElementById(event.target.id);
    if (event.target.classList.contains('imageDiv')) {
      event.preventDefault();
  		let id = event.dataTransfer.getData('text/plain');
	  	let elm_drag = document.getElementById(id);

		  let rect = underImage.getBoundingClientRect();
  		if ((event.clientY - rect.top) < (underImage.clientHeight / 2)) {
  			//マウスカーソルの位置が要素の半分より上
  			underImage.parentNode.insertBefore(elm_drag, underImage);
  		} else {
  			//マウスカーソルの位置が要素の半分より下
  			underImage.parentNode.insertBefore(elm_drag, underImage.nextSibling);
  		}
  		underImage.style.borderTop = '';
  		underImage.style.borderBottom = '';
    }
	});

  // 写真の横に表示しているファイル名を変更する処理
  elm.addEventListener('dblclick', (event) => {
    if (event.target.classList.contains('imageCaption')) {
      let result = prompt('変更後のファイル名を入力してください');
			document.getElementById(event.target.id).innerText = result;
    }
  })

  // ヘッダーとして表示する文字列の設定
  document.getElementById('headerText').addEventListener('change', () => {
    document.getElementById('header').innerText = event.target.value;
  })

  // 読み込んだファイルが画像ファイルならファイルタイプを返し、
  // 画像ファイル以外なら false を返す関数
  // https://qiita.com/hal9188/items/a1378f5b101e991609a8
  function getImageFormat(arrayBuffer) {
    let arr = new Uint8Array(arrayBuffer).subarray(0, 4);
    let header = '';

    for(let i = 0; i < arr.length; i++) {
      header += arr[i].toString(16);
    }

    switch(true) {
      case /^89504e47/.test(header):
        return 'image/png';
      case /^47494638/.test(header):
        return 'image/gif';
      case /^424d/.test(header):
        return 'image/bmp';
      case /^ffd8ff/.test(header):
        return 'image/jpeg';
      default:
        return false;
    }
  }

  // 読み込んだ画像データを基にDOMを生成する
  function imageListDom(imageFiles) {
    // imageFiles の画像ファイルをファイル名で並べ替える
    // （ファイル読み込みが非同期なので順番がランダム）
    imageFiles.sort((a, b) => {
      if (a.name < b.name) {
        return -1;
      }
      if (a.name > b.name) {
        return 1;
      }
      return 0;
    });
    imageFiles.forEach((imageFile, index) => {
      let imageDiv = document.createElement("div");
      imageDiv.className = "imageDiv";
      imageDiv.setAttribute('id', imageFile.name + '_Div');
      imageDiv.setAttribute('draggable', true);

      let image = document.createElement("img");
      image.className = "thumb"
      image.src = arrayBufferToDataURL(imageFile.image);

      let imageCaption = document.createElement("span");
      imageCaption.innerText = imageFile.name.split('.')[0];
      imageCaption.className = "imageCaption";
      imageCaption.setAttribute('id', imageFile.name + '_Span')

      imageDiv.insertBefore(image, null);
      imageDiv.insertBefore(imageCaption, null);
      document.getElementById("imageList").insertBefore(imageDiv, null);
    })
    document.getElementById('progressP').innerText = ''
  }

  // arrayBuffer 型の画像データを DataURL に変換する
  // (getImageFormat 関数のために arrayBuffer 型で読み込んでいる)
  function arrayBufferToDataURL(arrayBuffer) {
    let binary = '';
    let bytes = new Uint8Array(arrayBuffer);
    bytes.forEach((byte) => {
      binary += String.fromCharCode(byte);
    })
    return `data:${getImageFormat(arrayBuffer)};base64,${window.btoa(binary)}`;
  }
</script>
</html>
